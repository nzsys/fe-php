# Hybrid Backend Configuration Example
# This demonstrates the world's first Hybrid PHP Application Server
# combining libphp direct execution, PHP-FPM proxy, and static file serving

[server]
host = "localhost"
port = 8080
workers = 8

[php]
# Path to libphp.so
libphp_path = "/usr/local/php-zts-embed/lib/libphp.dylib"
document_root = "/Users/nzsys/Web"
worker_max_requests = 10000

# PHP-FPM socket (used by FastCGI backend)
fpm_socket = "127.0.0.1:9000"

# IMPORTANT: use_fpm is ignored when hybrid mode is enabled
# Each backend (embedded/fastcgi) is configured independently
use_fpm = false

[php.opcache]
enable = true
memory_size = "256M"
max_files = 10000
validate_timestamps = false

[logging]
level = "info"
format = "json"
output = "stdout"

[metrics]
enable = true
endpoint = "/_metrics"
port = 9090

[waf]
enable = true
mode = "block"
rules_path = "examples/waf_rules.toml"

[waf.rate_limit]
requests_per_ip = 100
window_seconds = 60
burst = 10

# ============================================================
# Hybrid Backend Configuration
# ============================================================

[backend]
# Enable hybrid backend system
enable_hybrid = true

# Default backend when no routing rules match
# Options: "embedded", "fastcgi", "static"
default_backend = "embedded"

# Static file serving configuration
[backend.static_files]
enable = true
root = "/Users/nzsys/Web/public"
index_files = ["index.html", "index.htm"]

# ============================================================
# Routing Rules (evaluated in priority order, highest first)
# ============================================================

# Rule 1: Health check and metrics use embedded backend (fastest)
[[backend.routing_rules]]
pattern = { type = "exact", value = "/_health" }
backend = "embedded"
priority = 100

[[backend.routing_rules]]
pattern = { type = "exact", value = "/_metrics" }
backend = "embedded"
priority = 100

# Rule 2: API endpoints requiring high performance use embedded libphp
[[backend.routing_rules]]
pattern = { type = "prefix", value = "/api/quick/" }
backend = "embedded"
priority = 90

# Rule 3: Static assets (images, CSS, JS)
[[backend.routing_rules]]
pattern = { type = "suffix", value = ".jpg" }
backend = "static"
priority = 80

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".jpeg" }
backend = "static"
priority = 80

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".png" }
backend = "static"
priority = 80

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".gif" }
backend = "static"
priority = 80

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".webp" }
backend = "static"
priority = 80

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".svg" }
backend = "static"
priority = 80

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".css" }
backend = "static"
priority = 80

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".js" }
backend = "static"
priority = 80

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".woff" }
backend = "static"
priority = 80

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".woff2" }
backend = "static"
priority = 80

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".ttf" }
backend = "static"
priority = 80

# Rule 4: Admin panel uses PHP-FPM for stability (isolated process)
[[backend.routing_rules]]
pattern = { type = "prefix", value = "/admin/" }
backend = "fastcgi"
priority = 70

# Rule 5: Long-running reports use PHP-FPM (prevents worker pool exhaustion)
[[backend.routing_rules]]
pattern = { type = "prefix", value = "/reports/" }
backend = "fastcgi"
priority = 70

# Rule 6: WordPress/legacy code uses PHP-FPM (better compatibility)
[[backend.routing_rules]]
pattern = { type = "prefix", value = "/wp-admin/" }
backend = "fastcgi"
priority = 70

[[backend.routing_rules]]
pattern = { type = "prefix", value = "/wp-content/" }
backend = "static"
priority = 75

# Rule 7: Regex example - versioned API endpoints
[[backend.routing_rules]]
pattern = { type = "regex", value = "^/api/v\\d+/" }
backend = "embedded"
priority = 60

# Rule 8: All other PHP files use embedded backend (high performance)
[[backend.routing_rules]]
pattern = { type = "suffix", value = ".php" }
backend = "embedded"
priority = 50

# ============================================================
# Routing Strategy Explanation:
# ============================================================
#
# 1. **Embedded Backend (libphp)** - FASTEST (50-100x faster than PHP-FPM)
#    - Best for: API endpoints, frequently accessed pages
#    - Limitations: Shared worker pool, potential memory leaks
#
# 2. **FastCGI Backend (PHP-FPM)** - STABLE
#    - Best for: Admin panels, long-running tasks, legacy code
#    - Advantages: Process isolation, better stability, graceful restarts
#    - Trade-off: Slower due to FastCGI protocol overhead
#
# 3. **Static Backend** - ULTRA FAST (zero PHP overhead)
#    - Best for: Images, CSS, JS, fonts, videos
#    - Advantages: Direct file serving, caching, ETag support
#
# ============================================================
# Performance Characteristics:
# ============================================================
#
# Embedded (libphp):    ~1-2ms   (in-process execution)
# FastCGI (PHP-FPM):    ~5-10ms  (socket + protocol overhead)
# Static files:         ~0.1-0.5ms (direct file read)
#
# ============================================================
# Example Use Cases:
# ============================================================
#
# **E-commerce Site:**
# - Product API:        /api/quick/products     → embedded (fast)
# - Images:             /images/*.jpg           → static (cached)
# - Admin panel:        /admin/orders           → fastcgi (isolated)
# - Monthly reports:    /reports/sales          → fastcgi (long-running)
#
# **WordPress Site:**
# - Public pages:       /blog/post.php          → embedded (fast)
# - Admin:              /wp-admin/*             → fastcgi (stable)
# - Uploads:            /wp-content/uploads/*   → static (efficient)
#
# ============================================================
