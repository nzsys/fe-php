# Advanced Configuration Example for fe-php
# This configuration demonstrates:
# - Unix socket support
# - HTTP/2 enablement
# - Connection pooling with circuit breaker
# - Per-backend configuration

[server]
# Listen type: "tcp" or "unix"
listen_type = "tcp"  # Change to "unix" to use Unix socket
host = "localhost"
port = 8080
# Unix socket path (only used when listen_type = "unix")
unix_socket_path = "/var/run/fe-php.sock"
workers = 8
enable_http2 = true  # Enable HTTP/2 support
multi_process = false

[php]
libphp_path = "/usr/local/php-zts-embed/lib/libphp.dylib"
document_root = "/Users/nzsys/Web"
worker_max_requests = 10000
use_fpm = false
fpm_socket = "127.0.0.1:9000"

[php.opcache]
enable = true
memory_size = "256M"
max_files = 10000
validate_timestamps = false

[logging]
level = "info"
format = "json"
output = "stdout"

[metrics]
enable = true
endpoint = "/_metrics"
port = 9090

[waf]
enable = true
mode = "block"
rules_path = "examples/waf_rules.toml"

[waf.rate_limit]
requests_per_ip = 100
window_seconds = 60
burst = 10

[admin]
enable = true
unix_socket = "/var/run/fe-php.sock"
http_port = 9000
allowed_ips = ["127.0.0.1"]

# Backend configuration with connection pooling
[backend]
enable_hybrid = true
default_backend = "embedded"

# Connection pool configuration
[backend.connection_pool]
max_size = 20                    # Maximum connections per pool
max_idle_time_secs = 60          # Maximum idle time before connection is closed
max_lifetime_secs = 3600         # Maximum connection lifetime
connect_timeout_secs = 5         # Connection timeout
enable_metrics = true            # Enable connection pool metrics

# Circuit breaker configuration
[backend.connection_pool.circuit_breaker]
enable = true                    # Enable circuit breaker
failure_threshold = 5            # Number of failures before opening circuit
success_threshold = 2            # Number of successes to close circuit
timeout_seconds = 60             # Timeout before attempting to close circuit
half_open_max_requests = 3       # Max requests in half-open state

[backend.static_files]
enable = true
root = "/Users/nzsys/Web/static"
index_files = ["index.html", "index.htm"]

# Routing rules - higher priority = evaluated first
[[backend.routing_rules]]
pattern = { type = "prefix", value = "/api/" }
backend = "embedded"
priority = 100

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".jpg" }
backend = "static"
priority = 90

[[backend.routing_rules]]
pattern = { type = "suffix", value = ".png" }
backend = "static"
priority = 90

[[backend.routing_rules]]
pattern = { type = "prefix", value = "/admin/" }
backend = "fastcgi"
priority = 80
